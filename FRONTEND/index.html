<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Ã‰cologie France - Indicateurs par commune</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div class="container">
        <h1>ðŸŒ¿ Indicateurs Ã‰cologiques</h1>

        <div class="search-box">
            <input type="text" id="commune-input" placeholder="Rechercher votre commune ...">
            <button onclick="rechercher()">OK</button>
        </div>

        <div id="loading" class="loading" style="display:none;">Chargement...</div>
        
        <div id="results" class="results"></div>
    </div>

    <footer>
        <p>Â© 2026 - rÃ©pertorie les actions Ã©cologiques de chaque commune</p>
        <p>ðŸš¨ Ã‰missions GES | ðŸš² AmÃ©nagements cyclables | ðŸ”Œ Bornes recharge | ðŸš— VÃ©hicules Ã©lectriques</p>
        <p><a href="https://www.data.gouv.fr/dataservices/hub-dindicateurs-territoriaux-de-transition-ecologique" style="color:#fff;">source</a></p>
    </footer>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';

        async function rechercher() {
            const commune = document.getElementById('commune-input').value.trim();
            if (!commune) return;

            const resultsDiv = document.getElementById('results');
            const loadingDiv = document.getElementById('loading');
            
            resultsDiv.innerHTML = '';
            loadingDiv.style.display = 'block';

            try {
                // Ã‰missions GES par habitant
                const gesData = await fetchIndicateur(
                    'emission_ges_hab_com',
                    'emission_ges_hab_com.id_2',
                    'emission_ges_hab_com.libelle_commune,emission_ges_hab_com.annee',
                    commune
                );

                // AmÃ©nagements cyclables
                const veloData = await fetchIndicateur(
                    'lineaire_cyclable_habitant_com',
                    'lineaire_cyclable_habitant_com.id_133',
                    'lineaire_cyclable_habitant_com.libelle_commune,lineaire_cyclable_habitant_com.annee',
                    commune
                );

                loadingDiv.style.display = 'none';
                afficherResultats(commune, gesData, veloData);

            } catch (error) {
                loadingDiv.style.display = 'none';
                resultsDiv.innerHTML = `<div class="error">Erreur: ${error.message}</div>`;
            }
        }

        async function fetchIndicateur(cube, measures, dimensions, commune) {
            const url = `${API_BASE}/indicateurs/query?cube=${cube}&measures=${measures}&dimensions=${dimensions}&filters=${cube.split('.')[0]}.libelle_commune:equals:${encodeURIComponent(commune)}&limit=10`;
            const response = await fetch(url);
            if (!response.ok) throw new Error('API non disponible');
            return response.json();
        }

        function afficherResultats(commune, gesData, veloData) {
            const resultsDiv = document.getElementById('results');
            
            let html = `<h2>RÃ©sultats pour ${commune}</h2>`;

            // Ã‰missions GES
            html += '<div class="card">';
            html += '<h3>ðŸš¨ Ã‰missions GES par habitant</h3>';
            if (gesData.data && gesData.data.length > 0) {
                html += '<table><tr><th>AnnÃ©e</th><th>tCO2eq/hab</th></tr>';
                gesData.data.forEach(row => {
                    const annee = row['emission_ges_hab_com.annee'];
                    const valeur = row['emission_ges_hab_com.id_2']?.toFixed(2) || 'N/A';
                    html += `<tr><td>${annee}</td><td>${valeur}</td></tr>`;
                });
                html += '</table>';
            } else {
                html += '<p class="no-data">Pas de donnÃ©es disponibles</p>';
            }
            html += '</div>';

            // AmÃ©nagements cyclables
            html += '<div class="card">';
            html += '<h3>ðŸš² AmÃ©nagements cyclables</h3>';
            if (veloData.data && veloData.data.length > 0) {
                html += '<table><tr><th>AnnÃ©e</th><th>km/1000 hab</th></tr>';
                veloData.data.forEach(row => {
                    const annee = row['lineaire_cyclable_habitant_com.annee'];
                    const valeur = row['lineaire_cyclable_habitant_com.id_133']?.toFixed(2) || 'N/A';
                    html += `<tr><td>${annee}</td><td>${valeur}</td></tr>`;
                });
                html += '</table>';
            } else {
                html += '<p class="no-data">Pas de donnÃ©es disponibles</p>';
            }
            html += '</div>';

            resultsDiv.innerHTML = html;
        }

        // Recherche avec Enter
        document.getElementById('commune-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') rechercher();
        });
    </script>

</body>
</html>


