<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Indicateurs √âcologiques</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>üåø Indicateurs √âcologiques</h1>
        
        <div class="search-box">
            <input type="text" id="commune" placeholder="Nom de la commune">
            <button onclick="rechercher()">Rechercher</button>
        </div>
        
        <div id="resultats"></div>
    </div>

    <script>
        let charts = [];
        
        function createChart(canvasId, label, labels, data, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });
            charts.push(chart);
        }
        
        async function rechercher() {
            const commune = document.getElementById('commune').value;
            const div = document.getElementById('resultats');
            
            if (!commune) return;
            div.innerHTML = 'Chargement...';
            charts.forEach(c => c.destroy());
            charts = [];
            
            try {
                const res = await fetch(`http://127.0.0.1:8000/indicateurs?commune=${commune}`);
                const json = await res.json();
                let html = `<h2>R√©sultats pour ${commune}</h2>`;
                
                // Mobilit√©
                html += '<div class="card"><h3>üö≤ Mobilit√© - Am√©nagements cyclables</h3>';
                if (json.mobilite && json.mobilite.length > 0) {
                    html += '<canvas id="chartMobilite"></canvas>';
                    html += '<table><tr><th>Ann√©e</th><th>Lin√©aire (km)</th></tr>';
                    json.mobilite.forEach(row => {
                        const val = parseFloat(row['lineaire_cyclable_habitant_com.id_839']) || 0;
                        html += `<tr><td>${row['lineaire_cyclable_habitant_com.annee']}</td><td>${val.toFixed(2)} km</td></tr>`;
                    });
                    html += '</table>';
                } else { html += '<p>Pas de donn√©es</p>'; }
                html += '</div>';
                
                // √ânergie
                html += '<div class="card"><h3>‚ö° √ânergie - Puissance √©lectrique install√©e</h3>';
                if (json.energie && json.energie.length > 0) {
                    html += '<canvas id="chartEnergie"></canvas>';
                    html += '<table><tr><th>Ann√©e</th><th>Puissance (MW)</th></tr>';
                    json.energie.forEach(row => {
                        const val = parseFloat(row['puissance_elec_installee_com.id_636']) || 0;
                        html += `<tr><td>${row['puissance_elec_installee_com.annee']}</td><td>${val.toFixed(2)} MW</td></tr>`;
                    });
                    html += '</table>';
                } else { html += '<p>Pas de donn√©es</p>'; }
                html += '</div>';
                
                // GES
                html += '<div class="card"><h3>üè≠ Sobri√©t√© - √âmissions GES par habitant</h3>';
                if (json.ges && json.ges.length > 0) {
                    html += '<canvas id="chartGES"></canvas>';
                    html += '<table><tr><th>Ann√©e</th><th>√âmissions (tCO2eq/hab)</th></tr>';
                    json.ges.forEach(row => {
                        const val = parseFloat(row['emission_ges_hab_com.id_2']) || 0;
                        html += `<tr><td>${row['emission_ges_hab_com.annee']}</td><td>${val.toFixed(2)}</td></tr>`;
                    });
                    html += '</table>';
                } else { html += '<p>Pas de donn√©es</p>'; }
                html += '</div>';
                
                // Biodiversit√©
                html += '<div class="card"><h3>üå≥ Biodiversit√© - S√©questration CO2</h3>';
                if (json.biodiversite && json.biodiversite.length > 0) {
                    html += '<canvas id="chartBio"></canvas>';
                    html += '<table><tr><th>Ann√©e</th><th>S√©questration (tCO2eq/an)</th></tr>';
                    json.biodiversite.forEach(row => {
                        const val = parseFloat(row['sequestr_nette_co2_com.id_615']) || 0;
                        html += `<tr><td>${row['sequestr_nette_co2_com.annee']}</td><td>${val.toLocaleString()}</td></tr>`;
                    });
                    html += '</table>';
                } else { html += '<p>Pas de donn√©es</p>'; }
                html += '</div>';
                
                // Eau
                html += '<div class="card"><h3>üíß Eau - Pr√©l√®vements</h3>';
                if (json.eau && json.eau.length > 0) {
                    html += '<canvas id="chartEau"></canvas>';
                    html += '<table><tr><th>Ann√©e</th><th>Volume (m¬≥)</th></tr>';
                    json.eau.forEach(row => {
                        const val = parseFloat(row['prelevement_eau_usage_com.id_638']) || 0;
                        html += `<tr><td>${row['prelevement_eau_usage_com.annee']}</td><td>${val.toLocaleString()}</td></tr>`;
                    });
                    html += '</table>';
                } else { html += '<p>Pas de donn√©es</p>'; }
                html += '</div>';
                
                div.innerHTML = html;
                
                // Cr√©er les graphiques
                if (json.mobilite && json.mobilite.length > 0) {
                    const labels = json.mobilite.map(r => r['lineaire_cyclable_habitant_com.annee']).reverse();
                    const data = json.mobilite.map(r => parseFloat(r['lineaire_cyclable_habitant_com.id_839']) || 0).reverse();
                    createChart('chartMobilite', 'km', labels, data, '#4CAF50');
                }
                if (json.energie && json.energie.length > 0) {
                    const labels = json.energie.map(r => r['puissance_elec_installee_com.annee']).reverse();
                    const data = json.energie.map(r => parseFloat(r['puissance_elec_installee_com.id_636']) || 0).reverse();
                    createChart('chartEnergie', 'MW', labels, data, '#FF9800');
                }
                if (json.ges && json.ges.length > 0) {
                    const labels = json.ges.map(r => r['emission_ges_hab_com.annee']).reverse();
                    const data = json.ges.map(r => parseFloat(r['emission_ges_hab_com.id_2']) || 0).reverse();
                    createChart('chartGES', 'tCO2eq/hab', labels, data, '#F44336');
                }
                if (json.biodiversite && json.biodiversite.length > 0) {
                    const labels = json.biodiversite.map(r => r['sequestr_nette_co2_com.annee']).reverse();
                    const data = json.biodiversite.map(r => parseFloat(r['sequestr_nette_co2_com.id_615']) || 0).reverse();
                    createChart('chartBio', 'tCO2eq/an', labels, data, '#8BC34A');
                }
                if (json.eau && json.eau.length > 0) {
                    const labels = json.eau.map(r => r['prelevement_eau_usage_com.annee']).reverse();
                    const data = json.eau.map(r => parseFloat(r['prelevement_eau_usage_com.id_638']) || 0).reverse();
                    createChart('chartEau', 'm¬≥', labels, data, '#2196F3');
                }
            } catch (e) {
                div.innerHTML = '<p>Erreur de connexion √† l\'API</p>';
            }
        }
        
        document.getElementById('commune').addEventListener('keypress', e => {
            if (e.key === 'Enter') rechercher();
        });
    </script>
</body>
</html>


